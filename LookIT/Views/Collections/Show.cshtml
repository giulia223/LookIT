@model LookIT.Models.Collection

<div class="container mt-4 mb-5">

    @* HEADER *@
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h1 class="fw-bold mb-0">@Model.Name</h1>
            <p class="text-muted">@Model.PostCollections.Count postări salvate</p>
        </div>
        @if ((Model.UserId == ViewBag.UserCurent || ViewBag.EsteAdministrator) && Model.Name != "All Posts")
        {
            <div class="d-flex gap-2">
                <a asp-action="Edit" asp-controller="Collections" asp-area="" asp-route-Id="@Model.CollectionId" class="btn btn-outline-secondary rounded-pill btn-sm">
                    Editează
                </a>
                <form method="post" asp-controller="Collections" asp-action="Delete" asp-route-Id="@Model.CollectionId">
                    <button type="submit" class="btn btn-outline-danger rounded-pill btn-sm">Șterge Colecția</button>
                </form>
            </div>
        }
    </div>

    <hr class="mb-4" />

    @if (Model.PostCollections.Count > 0)
    {
        <div class="row g-1">
            @foreach (var pc in Model.PostCollections)
            {
                @if (pc.Post != null)
                {
                    <div class="col-4">

                        @* CARD PRINCIPAL *@
                        <div class="ratio ratio-1x1 border-0 rounded-0 overflow-hidden position-relative shadow-sm bg-light post-card-hover">

                            @* ========================================================== *@
                            @* 1. HEADER CARD (SUS): STERGE (Stanga) <---> ICONITA (Dreapta) *@
                            @* ========================================================== *@

                            @* Wrapper Flexibil care acopera partea de sus *@
                            <div class="position-absolute top-0 start-0 w-100 p-2 d-flex justify-content-between align-items-start" style="z-index: 30; pointer-events: none;">

                                @* B. ELEMENT DREAPTA: Iconita Tip *@
                                <div>
                                    @if (!string.IsNullOrEmpty(pc.Post.VideoUrl))
                                    {
                                        <i class="bi bi-camera-reels-fill text-white fs-5 drop-shadow-icon"></i>
                                    }
                                    else if (!string.IsNullOrEmpty(pc.Post.ImageUrl))
                                    {
                                        <i class="bi bi-image-fill text-white fs-5 drop-shadow-icon"></i>
                                    }
                                    else
                                    {
                                        <i class="bi bi-file-text-fill text-white fs-5 drop-shadow-icon"></i>
                                    }
                                </div>

                                @* A. ELEMENT STANGA: Buton Stergere (Doar daca e owner) *@
                                <div style="pointer-events: auto;">
                                    @* pointer-events: auto pt a putea da click pe buton *@
                                    @if ((Model.UserId == ViewBag.UserCurent || ViewBag.EsteAdministrator))
                                    {
                                        <form method="post" asp-controller="Posts" asp-action="RemoveFromCollection">
                                            <input type="hidden" name="postId" value="@pc.PostId" />
                                            <input type="hidden" name="collectionId" value="@Model.CollectionId" />

                                            <button type="submit" class="btn btn-sm btn-dark bg-opacity-25 border-0 rounded-circle text-white d-flex align-items-center justify-content-center hover-danger"
                                                    style="width: 30px; height: 30px; backdrop-filter: blur(2px);"
                                                    title="Elimină din colecție"
                                                    onclick="return confirm('Elimini postarea din colecție?');">
                                                <i class="bi bi-x-lg" style="font-size: 0.8rem;"></i>
                                            </button>
                                        </form>
                                    }
                                </div>

                            </div>

                            @* ========================================================== *@
                            @* 2. LINK + CONTINUT + OVERLAY JOS                           *@
                            @* ========================================================== *@
                            <a href="/Posts/Show/@pc.PostId" class="text-decoration-none d-block w-100 h-100 user-select-none">

                                @* --- OVERLAY LA HOVER (JOS) --- *@
                                <div class="hover-overlay p-3">
                                    <div class="d-flex align-items-end justify-content-between w-100 h-100">

                                        @* STANGA JOS: Autor *@
                                        <div class="d-flex align-items-center text-truncate" style="max-width: 60%;">
                                            <img src="@(pc.Post.Author?.ProfilePictureUrl)"
                                                 class="rounded-circle border border-1 border-white"
                                                 alt="User"
                                                 style="width: 30px; height: 30px; object-fit: cover; flex-shrink: 0;">
                                            <span class="text-white ms-2 fw-bold text-truncate text-shadow" style="font-size: 1rem;">
                                                @(pc.Post.Author?.FullName)
                                            </span>
                                        </div>

                                        @* DREAPTA JOS: Data *@
                                        <div class="text-white text-end text-shadow" style="max-width: 40%;">
                                            <div style="font-size: 0.65rem; opacity: 0.8; line-height: 1;">Adăugat la:</div>
                                            <div class="fw-bold" style="font-size: 0.8rem;">
                                                @pc.AddedDate.ToString("dd MMM")
                                            </div>
                                        </div>

                                    </div>
                                </div>

                                @* --- VISUAL CONTENT --- *@
                                @if (!string.IsNullOrEmpty(pc.Post.ImageUrl))
                                {
                                    <img src="@pc.Post.ImageUrl" class="w-100 h-100" style="object-fit: cover;" alt="Post Image">
                                }
                                else if (!string.IsNullOrEmpty(pc.Post.VideoUrl))
                                {
                                    <video class="w-100 h-100" style="object-fit: cover;" muted>
                                        <source src="@pc.Post.VideoUrl" type="video/mp4">
                                    </video>
                                }
                                else
                                {
                                    <div class="d-flex flex-column align-items-center justify-content-center h-100 p-3 text-center bg-white">
                                        <i class="bi bi-quote fs-1 text-muted opacity-25 mb-1"></i>
                                        <small class="fw-bold text-dark text-break fst-italic font-georgia">
                                            @{
                                                var rawHtml = pc.Post.TextContent ?? "";
                                                var plainText = System.Text.RegularExpressions.Regex.Replace(rawHtml, "<.*?>", " ").Trim();
                                                var previewText = plainText.Length > 60 ? plainText.Substring(0, 60) + "..." : plainText;
                                            }
                                            @previewText
                                        </small>
                                    </div>
                                }
                            </a>

                        </div>
                    </div>
                }
            }
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <i class="bi bi-grid-3x3" style="font-size: 3rem; color: #dee2e6;"></i>
            <p class="mt-3 text-muted">Această colecție este goală.</p>
        </div>
    }
</div>

<style>
    .post-card-hover {
        transform: translateZ(0);
    }

    .hover-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
        z-index: 10;
    }

    .post-card-hover:hover .hover-overlay {
        opacity: 1;
    }

    .drop-shadow-icon {
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.8));
        color: #fff !important;
    }

    .text-shadow {
        text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }

    .font-georgia {
        font-family: 'Georgia', serif;
        line-height: 1.3;
    }

    .hover-danger {
        transition: all 0.2s ease;
    }

        .hover-danger:hover {
            background-color: #dc3545 !important;
            opacity: 1 !important;
            transform: scale(1.1);
        }
</style>