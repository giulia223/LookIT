@model LookIT.Models.ApplicationUser

@{
    ViewData["Title"] = "Profil - " + Model.FullName;
    bool showFullProfile = ViewBag.ShowFullProfile;
}

<div class="container mt-4 mb-5">

    @* --- 0. BUTON ÎNAPOI (NOU) --- *@
    <div class="mb-4">
        <a href="javascript:history.back()" class="btn btn-sm btn-light rounded-pill px-3 fw-bold text-muted border-0 shadow-sm">
            <i class="bi bi-arrow-left me-1"></i> Înapoi
        </a>
    </div>

    @* --- 1. CARD PROFIL HEADER --- *@
    <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
        <div class="card-body p-4 text-center">
            
            @* Poza de profil *@
            <div class="d-inline-block position-relative mb-3">
                <img src="@(!string.IsNullOrEmpty(Model.ProfilePictureUrl) ? Model.ProfilePictureUrl : "/images/default-profile.png")"
                     alt="Profile Picture"
                     class="rounded-circle shadow-sm"
                     style="width: 140px; height: 140px; object-fit: cover; box-shadow: 0 0 0 2px #FBF1F7;" />
            </div>

            <h3 class="fw-bold mb-1">@Model.FullName</h3>
            
            @* Descriere *@
            <p class="text-muted small mx-auto mb-3" style="max-width: 500px;">
                @if (!string.IsNullOrEmpty(Model.Description))
                {
                    @Model.Description
                }
                else
                {
                    <span class="fst-italic opacity-50">Fără descriere.</span>
                }
            </p>

            @* Statistici (Postări, Urmăritori, Urmăriri) *@
            <div class="d-flex justify-content-center gap-4 gap-md-5 my-4 border-top border-bottom py-3 bg-light bg-opacity-25">
                
                @* Postări *@
                <div class="text-center">
                    <span class="fw-bold d-block fs-5 text-dark">@ViewBag.UserPosts.Count</span>
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Postări</small>
                </div>

                @* Urmăritori *@
                <div class="text-center">
                    @if (showFullProfile)
                    {
                        <a asp-action="Followers" asp-route-userId="@Model.Id" class="text-decoration-none text-dark hover-magenta">
                            <span class="fw-bold d-block fs-5">@ViewBag.FollowersCount</span>
                            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Urmăritori</small>
                        </a>
                    }
                    else
                    {
                        <span class="fw-bold d-block fs-5">@ViewBag.FollowersCount</span>
                        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Urmăritori</small>
                    }
                </div>

                @* Urmăriri *@
                <div class="text-center">
                    @if (showFullProfile)
                    {
                        <a asp-action="Following" asp-route-userId="@Model.Id" class="text-decoration-none text-dark hover-magenta">
                            <span class="fw-bold d-block fs-5">@ViewBag.FollowingCount</span>
                            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Urmăriri</small>
                        </a>
                    }
                    else
                    {
                        <span class="fw-bold d-block fs-5">@ViewBag.FollowingCount</span>
                        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Urmăriri</small>
                    }
                </div>
            </div>

            @* Cont Privat Badge *@
            @if (!Model.Public)
            {
                <div class="mb-3">
                    <span class="badge bg-light text-secondary border rounded-pill px-3 py-2">
                        <i class="bi bi-lock-fill me-1"></i> Cont Privat
                    </span>
                </div>
            }

            @* --- ZONA DE ACȚIUNI (BUTOANE) --- *@
            <div class="d-flex flex-wrap justify-content-center gap-2">
                @if (ViewBag.IsOwner)
                {
                    @* PROPRIETAR *@
                    <a asp-action="Edit" class="btn btn-outline-secondary rounded-pill px-4 fw-bold btn-action">
                        <i class="bi bi-pencil-square me-1"></i> Editează
                    </a>

                    <a asp-controller="FollowRequests" asp-action="MyRequests" 
                       class="btn btn-outline-secondary rounded-pill px-3 fw-bold btn-action position-relative" 
                       data-bs-toggle="tooltip" title="Cereri de urmărire">
                        <i class="bi bi-person-check-fill"></i>
                        @if (ViewBag.HasPendingRequests == true)
                        {
                            <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle"></span>
                        }
                    </a>

                    <a asp-action="Index" asp-controller="Collections" class="btn btn-outline-secondary rounded-pill px-3 fw-bold btn-action" data-bs-toggle="tooltip" title="Colecții">
                        <i class="bi bi-bookmark-fill"></i>
                    </a>

                    <a asp-action="Index" asp-controller="Likes" class="btn btn-outline-secondary rounded-pill px-3 fw-bold btn-action" data-bs-toggle="tooltip" title="Apreciate">
                        <i class="bi bi-heart-fill"></i>
                    </a>
                }
                else if (User.Identity.IsAuthenticated)
                {
                    @* VIZITATOR *@
                    <form asp-action="FollowToggle" asp-route-userId="@Model.Id" method="post">
                        @if (ViewBag.IsFollowing)
                        {
                            <button type="submit" class="btn btn-outline-secondary rounded-pill px-4 fw-bold btn-action">
                                Urmărești <i class="bi bi-check2"></i>
                            </button>
                        }
                        else if (ViewBag.IsPending)
                        {
                            <button type="submit" class="btn btn-secondary rounded-pill px-4 fw-bold disabled border-0">
                                Cerere trimisă
                            </button>
                        }
                        else
                        {
                            <button type="submit" class="btn btn-primary rounded-pill px-5 fw-bold shadow-sm">
                                Urmărește
                            </button>
                        }
                    </form>
                }
            </div>
        </div>
    </div>

    @* --- 2. GRID POSTĂRI --- *@
    @if (showFullProfile)
    {
        var posts = ViewBag.UserPosts as List<LookIT.Models.Post>;
        if (posts != null && posts.Any())
        {
            <div class="row g-1">
                @foreach (var post in posts)
                {
                    <div class="col-4">
                        <a asp-controller="Posts" asp-action="Show" asp-route-id="@post.PostId" class="text-decoration-none user-select-none d-block">
                            <div class="ratio ratio-1x1 border-0 rounded-0 overflow-hidden position-relative shadow-sm bg-light post-card-hover">
                                
                                @* Iconiță tip conținut *@
                                <div class="position-absolute top-0 end-0 m-2" style="z-index: 10;">
                                    @if (!string.IsNullOrEmpty(post.VideoUrl))
                                    {
                                        <i class="bi bi-camera-reels-fill text-white fs-5 drop-shadow-icon"></i>
                                    }
                                    else if (!string.IsNullOrEmpty(post.ImageUrl))
                                    {
                                        <i class="bi bi-image-fill text-white fs-5 drop-shadow-icon"></i>
                                    }
                                    else
                                    {
                                        <i class="bi bi-file-text-fill text-white fs-5 drop-shadow-icon"></i>
                                    }
                                </div>

                                @* Content *@
                                @if (!string.IsNullOrEmpty(post.ImageUrl))
                                {
                                    <img src="@post.ImageUrl" class="w-100 h-100" style="object-fit: cover;" alt="Post Image">
                                }
                                else if (!string.IsNullOrEmpty(post.VideoUrl))
                                {
                                    <video class="w-100 h-100" style="object-fit: cover;" muted>
                                        <source src="@post.VideoUrl" type="video/mp4">
                                    </video>
                                }
                                else
                                {
                                    <div class="d-flex flex-column align-items-center justify-content-center h-100 p-3 text-center bg-white">
                                        <i class="bi bi-quote fs-1 text-muted opacity-25 mb-1"></i>
                                        <small class="fw-bold text-dark text-break fst-italic px-2" style="font-family: 'Georgia', serif; line-height: 1.3;">
                                            @{
                                                var rawHtml = post.TextContent ?? "";
                                                var plainText = System.Text.RegularExpressions.Regex.Replace(rawHtml, "<.*?>", " ").Trim();
                                                var previewText = plainText.Length > 70 ? plainText.Substring(0, 70) + "..." : plainText;
                                            }
                                            @previewText
                                        </small>
                                    </div>
                                }
                                
                                @* Overlay *@
                                <div class="card-hover-overlay"></div>
                            </div>
                        </a>
                    </div>
                }
            </div>
        }
        else
        {
            @* FĂRĂ POSTĂRI *@
            <div class="text-center py-5 mt-4 rounded-4 bg-light border border-dashed">
                <div class="mb-3 text-muted opacity-25">
                    <i class="bi bi-grid-3x3" style="font-size: 3rem;"></i>
                </div>
                <h5 class="fw-bold text-dark">Încă nu există postări</h5>
            </div>
        }
    }
    else
    {
        @* CONT PRIVAT *@
        <div class="text-center py-5 mt-4 rounded-4 bg-light border border-dashed">
            <div class="mb-3 text-muted opacity-50">
                <i class="bi bi-lock-fill" style="font-size: 3rem;"></i>
            </div>
            <h4 class="fw-bold text-dark">Acest cont este privat</h4>
            <p class="text-muted small mx-auto" style="max-width: 350px;">
                Urmărește acest utilizator pentru a vedea fotografiile și clipurile postate.
            </p>
        </div>
    }
</div>

@* --- STILURI CSS --- *@
<style>
    .hover-magenta:hover { color: #B13079 !important; }

    .btn-action {
        background-color: #fff;
        border-color: #dee2e6;
        color: #495057;
        transition: all 0.2s ease;
    }

    .btn-action:hover {
        background-color: #f8f9fa;
        color: #B13079;
        border-color: #B13079;
    }

    .post-card-hover { position: relative; }

    .card-hover-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.3); opacity: 0;
        transition: opacity 0.2s ease; z-index: 5; pointer-events: none;
    }

    .post-card-hover:hover .card-hover-overlay { opacity: 1; }

    .drop-shadow-icon { filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.8)); }

    .border-dashed {
        border-style: dashed !important; border-color: #dee2e6 !important;
    }
</style>